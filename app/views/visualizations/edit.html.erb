<%- model_class = Visualization -%>
<% if @organization.present? %>
  <%= page_title t('helpers.titles.edit_visual', :model => model_class.model_name.human, :org => @organization.name) %>
<% else %>
  <%= page_title t('helpers.titles.edit_visual', :model => model_class.model_name.human) %>
<% end %>

<%= semantic_nested_form_for(@visualization,
      :url => visualization_path(:id => @visualization.permalink, :organization => params[:organization]),
      :html => { :class => 'form-horizontal precrop' }) do |f| %>
	<%= f.error_messages %>

	<div id="fields-panel">
		<div class="control-group">
			<div class="control-label">
				<%= Visualization.human_attribute_name(:visualization_type_id)%>
			</div>
			<div class="controls">
				<%= @visualization.visualization_type_name %>
			</div>
		</div>

	  <% @visualization.visualization_translations.sort{|x,y| x.locale <=> y.locale}.each do |trans| %>
			<%= f.fields_for :visualization_translations, trans do |translation| %>

				<div id="form-<%= trans.locale %>" class="multilanguage">
					<h3><%= t("app.language.#{trans.locale}") %></h3>

					<%= translation.input :title %>

					<% if !trans.interactive_url.blank? %>
						<div class="control-group">
							<div class="control-label">
								<%= VisualizationTranslation.human_attribute_name(:interactive_url)%>
							</div>
							<div class="controls">
								<%= link_to trans.interactive_url, trans.interactive_url, :target => :blank %>
							</div>
						</div>
					<% end %>

					<%= translation.fields_for :image_file do |upload| %>
						<div class="control-group">
							<div class="control-label">
								<%= ImageFile.human_attribute_name(:file)%>
							</div>
							<div class="controls">
								<%= image_tag trans.image.url(:thumb, false) if trans.image_file_name.present? %>
								<%# upload.input :reset_crop, :as => :select, :include_blank => false, :selected => false %>
                <%= link_to t('activerecord.attributes.image_file.reset_crop'), 
                    crop_image_visualization_path(:organization => params[:organization], :reset_crop => trans.locale), :class => 'btn btn-mini' %> 
                <% if @visualization.visualization_type_id == Visualization::TYPES[:infographic] %>
                  <%= link_to t('activerecord.attributes.image_file.reset_file'), 
                      load_images_visualization_path(:organization => params[:organization], :reset_file => trans.locale), :class => 'btn btn-mini' %> 
                <% elsif @visualization.visualization_type_id == Visualization::TYPES[:interactive] %>
                  <%= link_to t('activerecord.attributes.image_file.reset_url'), 
                      load_images_visualization_path(:organization => params[:organization], :reset_file => trans.locale), :class => 'btn btn-mini' %> 
                <% end %>
							</div>
						</div>

					<% end %>

<%
=begin %>
					<% if request.post? || request.put? || controller.action_name.downcase == 'edit' %>
						<%= translation.input :permalink,
								:hint => t('activerecord.attributes.visualization_translation.permalink_hint') %>
					<% end %>
<%
=end %>
					<%= translation.input :explanation %>
					<%= translation.input :reporter %>
					<%= translation.input :designer %>

          <div class="nested_form_container">
						<div class="control-group">
							<div class="control-label">
								<%= t(".datasources_header") %>
							</div>
							<div class="controls">
	              <%= translation.fields_for :datasources %>
	              <p><%= translation.link_to_add t(".add_datasource"), :datasources, :class => "btn btn-mini btn-primary" %></p>
							</div>
						</div>
          </div>

					<%= translation.fields_for :dataset_file do |upload| %>
						<%= upload.input :file, :as => :file %>
						<div class="control-group">
							<div class="controls">
								<%= link_to t('helpers.links.existing_file'), @visualization.dataset.url, :class => 'btn' if @visualization.dataset_file_name %>
							</div>
						</div>

					<% end %>

					<%= translation.hidden_field :locale , :value => trans.locale %>
				</div>

			<% end %>
		<% end %>


		<%= f.inputs do %>

			<%= f.input :categories, :as => :check_boxes, :collection => @categories %>
			<%= f.input :published, :as => :radio %>
			<%= f.input :published_date, :as => :string, :input_html => {:size => 20} %>

      <% if current_user.role?(User::ROLES[:visual_promotion]) %>
			  <%= f.input :is_promoted, :as => :radio %>
      <% end %>
		<% end %>

	</div>  
  <div class="form-actions">
    <%= f.submit nil, :class => 'btn btn-primary' %>
	  <%= f.submit nil, :class => 'btn btn-warning', :type => :reset, :value => t('helpers.links.reset'), :name => :reset %>
    <%= link_to t('.cancel', :default => t("helpers.links.cancel")),
                visualizations_path(:organization => params[:organization]), :class => 'btn' %>
  </div>
<% end %>
