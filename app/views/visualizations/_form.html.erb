<%
  if params[:action] == 'new' || params[:action] == 'create'
    path = organization_visualizations_path(params[:organization_id])
  else
    path = organization_visualization_path(params[:organization_id], params[:id])
  end
%>
<%= semantic_form_for([@organization, @visualization],
      :url => path,
      :html => { :class => 'form-horizontal precrop' }) do |f| %>
		<%= f.error_messages %>

	<% if @visualization.id.nil? %>
		<div id="fields-panel">
			<%= f.inputs do %>
				<%= f.hidden_field :organization_id ,	:value => @organization.id %>

				<%= f.input :visualization_type_id, :as => :radio, :collection => visualization_type_collection %>

				<%= f.input :languages_internal, :as => :check_boxes,
				  :collection => I18n.available_locales.map{|x| [t("app.language.#{x}"), x]},
				  :input_html => {:checked => 'checked'} %>

				<% @visualization.visualization_translations.sort{|x,y| x.locale <=> y.locale}.each do |trans| %>
					<%= f.fields_for :visualization_translations, trans do |translation| %>

						<div id="form-<%= trans.locale %>" class="multilanguage">
							<h3><%= t("app.language.#{trans.locale}") %></h3>

							<%= translation.input :title %>
							<div class="trans_visual_file" style="display: none">
								<%= translation.fields_for :upload_files do |upload| %>
	      				  <%= upload.hidden_field :type_id, :value => UploadFile::TYPES[:image] %>
	      				  <%= upload.input :upload, :as => :file %>
								<% end %>
      				</div>
      				<div class="trans_interactive_url" style="display: none">
      				<%= translation.input :interactive_url, :as => :url %>
      				</div>
							<%= translation.hidden_field :locale , :value => trans.locale %>
						</div>

					<% end %>
				<% end %>

			<% end %>
		</div>
	<% elsif !@locale_to_crop.blank? %>
		<% trans = @visualization.visualization_translations.select{|x| x.locale == @locale_to_crop}.first %>
		<%= f.fields_for :visualization_translations, trans do |translation| %>

			<h3><%= t('.crop_image', :language => t("app.language.#{@locale_to_crop}")) %></h3>
			<%= translation.hidden_field :locale , :value => @locale_to_crop %>
			<%= translation.hidden_field :visual_is_cropped, :value => true %>
			<%= translation.fields_for :upload_files do |upload| %>
				<%= upload.hidden_field :crop_x %>
				<%= upload.hidden_field :crop_y %>
				<%= upload.hidden_field :crop_w %>
				<%= upload.hidden_field :crop_h %>
			<% end %>

			<div id="crop-panel">
				<h4><%= t('.preview')%>:</h4>
				<div class="preview">
					<%= image_tag @visualization.image.url(:large, false), :id => "cropbox_preview" %>
				</div>

				<hr />

				<%= image_tag @visualization.image.url(:large, false), :id => "cropbox" %>

			</div>
		<% end %>
	<% else %>
		<div id="fields-panel">
			<div>
				<p>
					<strong><%= Visualization.human_attribute_name(:visualization_type_id)%>:</strong>
					<%= @visualization.visualization_type_name %>
				</p>
				<% if !@visualization.interactive_url.blank? %>
				<p>
					<strong><%= Visualization.human_attribute_name(:interactive_url)%>:</strong>
					<%= link_to @visualization.interactive_url, @visualization.interactive_url, :target => :blank %>
				</p>
				<% end %>
				<p>
					<strong><%= Visualization.human_attribute_name(:visual)%>:</strong>
			    <%= f.input :reset_crop, :as => :select, :include_blank => false, :selected => false %>
					<br />
					<%= image_tag @visualization.image.url(:thumb, false) if !@visualization.image_file_name.blank? %>
				</p>
			</div>

		  <% @visualization.visualization_translations.sort{|x,y| x.locale <=> y.locale}.each do |trans| %>
				<%= f.fields_for :visualization_translations, trans do |translation| %>

					<div id="form-<%= trans.locale %>" class="multilanguage">
						<h3><%= t("app.language.#{trans.locale}") %></h3>

						<%= translation.input :title %>
						<% if request.post? || request.put? || controller.action_name.downcase == 'edit' %>
							<%= translation.input :permalink, :hint => t('activerecord.attributes.visualization_translation.permalink_hint') %>
						<% end %>
						<%= translation.input :explanation %>
						<%= translation.input :reporter %>
						<%= translation.input :designer %>
						<%= translation.input :data_source_name %>
						<%= translation.input :data_source_url, :as => :url %>
						<%= translation.hidden_field :locale , :value => trans.locale %>
					</div>

				<% end %>
			<% end %>


			<%= f.inputs do %>

				<%= f.input :categories, :as => :check_boxes, :collection => @categories %>

				<%= f.input :dataset, :as => :file %>
				<%= link_to t('helpers.links.download'), @visualization.dataset.url if @visualization.dataset_file_name %>

				<%= f.input :published, :as => :radio %>
				<%= f.input :published_date, :as => :string, :input_html => {:size => 20} %>
			<% end %>

		</div>

	<% end %>


  <div class="form-actions">
    <%= f.submit nil, :class => 'btn btn-primary' %>
	  <%= f.submit nil, :class => 'btn btn-warning', :type => :reset, :value => t('helpers.links.reset'), :name => :reset %>
    <%= link_to t('.cancel', :default => t("helpers.links.cancel")),
                organization_path(params[:organization_id]), :class => 'btn' %>
  </div>
<% end %>
